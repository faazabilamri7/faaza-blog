---
import Layout from '~/layouts/PageLayout.astro';
import type { MetaData } from '~/types';

const query = Astro.url.searchParams.get('q') || '';

const metadata: MetaData = {
  title: 'Search',
  description: 'Search blog posts',
};
---

<Layout metadata={metadata}>
  <section class="px-4 md:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-6xl">
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-4">Search</h1>
      <div id="searchbox" class="mb-4"></div>
      <div id="stats" class="text-sm text-gray-600 dark:text-gray-400 mb-4"></div>
    </div>
    <div class="flex flex-col lg:flex-row gap-8">
      <aside class="lg:w-1/4">
        <div id="category-refinement" class="mb-6"></div>
        <div id="tag-refinement" class="mb-6"></div>
        <div id="date-range" class="mb-6"></div>
      </aside>
      <main class="lg:w-3/4">
        <div id="hits" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
        <div id="pagination" class="mt-8"></div>
      </main>
    </div>
  </section>
</Layout>

<script>
  import instantsearch from 'instantsearch.js';
  import { searchBox, hits, pagination, stats, refinementList, rangeInput } from 'instantsearch.js/es/widgets';
  import { algoliasearch } from 'algoliasearch';

  const searchClient = algoliasearch('YOUR_APP_ID', 'YOUR_SEARCH_ONLY_API_KEY');

  const search = instantsearch({
    indexName: 'posts',
    searchClient,
  });

  search.addWidgets([
    searchBox({
      container: '#searchbox',
      placeholder: 'Search posts...',
    }),
    refinementList({
      container: '#category-refinement',
      attribute: 'category.title',
      searchable: true,
      searchablePlaceholder: 'Search categories',
      showMore: true,
      showMoreLimit: 10,
    }),
    refinementList({
      container: '#tag-refinement',
      attribute: 'tags.title',
      searchable: true,
      searchablePlaceholder: 'Search tags',
      showMore: true,
      showMoreLimit: 10,
    }),
    rangeInput({
      container: '#date-range',
      attribute: 'publishDate',
      templates: {
        separatorText: 'to',
        submitText: 'Go',
      },
    }),
    hits({
      container: '#hits',
      templates: {
        item: (hit) => `
          <article class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-2">
              <a href="/${hit.permalink}" class="hover:text-primary">${hit.title}</a>
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mb-4">${hit.excerpt}</p>
            <div class="flex items-center text-sm text-gray-500">
              <span>${new Date(hit.publishDate).toLocaleDateString()}</span>
              ${hit.category ? `<span class="ml-2">â€¢ ${hit.category.title}</span>` : ''}
            </div>
            ${hit.tags ? `<div class="mt-2">${hit.tags.map(tag => `<span class="inline-block bg-gray-200 dark:bg-gray-700 rounded-full px-2 py-1 text-xs mr-2">${tag.title}</span>`).join('')}</div>` : ''}
          </article>
        `,
      },
    }),
    pagination({
      container: '#pagination',
    }),
    stats({
      container: '#stats',
    }),
  ]);

  search.start();
</script>
---
// NewsletterSignup.astro
export interface Props {
  title?: string;
  description?: string;
  class?: string;
}

const {
  title = 'Subscribe to our newsletter',
  description = 'Get the latest posts delivered right to your inbox.',
  class: className = ''
} = Astro.props;

const mailchimpApiKey = import.meta.env.PUBLIC_MAILCHIMP_API_KEY;
const mailchimpAudienceId = import.meta.env.PUBLIC_MAILCHIMP_AUDIENCE_ID;
const mailchimpServer = import.meta.env.PUBLIC_MAILCHIMP_SERVER_PREFIX;
---

<div class={`p-6 bg-gray-50 dark:bg-gray-800 rounded-lg ${className}`}>
  <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">{title}</h3>
  <p class="text-gray-600 dark:text-gray-300 mb-4">{description}</p>
  <form id="newsletter-form" class="flex flex-col sm:flex-row gap-2">
    <input
      type="email"
      name="email"
      id="email"
      placeholder="Enter your email"
      required
      class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
      aria-label="Email address"
    />
    <button
      type="submit"
      id="submit-btn"
      class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary transition-colors"
    >
      Subscribe
    </button>
  </form>
  <p id="message" class="mt-2 text-sm text-gray-600 dark:text-gray-300 hidden"></p>
</div>

<script define:vars={{ mailchimpApiKey, mailchimpAudienceId, mailchimpServer }}>
  document.getElementById('newsletter-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const submitBtn = document.getElementById('submit-btn');
    const message = document.getElementById('message');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Subscribing...';

    try {
      const response = await fetch(`https://${mailchimpServer}.api.mailchimp.com/3.0/lists/${mailchimpAudienceId}/members`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Basic ${btoa(`anystring:${mailchimpApiKey}`)}`
        },
        body: JSON.stringify({
          email_address: email,
          status: 'pending' // Double opt-in
        })
      });

      if (response.ok) {
        message.textContent = 'Thank you! Please check your email to confirm your subscription.';
        message.classList.remove('hidden');
        message.classList.add('text-green-600');
        document.getElementById('email').value = '';
      } else {
        const error = await response.json();
        throw new Error(error.detail || 'Subscription failed');
      }
    } catch (error) {
      message.textContent = `Error: ${error.message}`;
      message.classList.remove('hidden');
      message.classList.add('text-red-600');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Subscribe';
    }
  });
</script>